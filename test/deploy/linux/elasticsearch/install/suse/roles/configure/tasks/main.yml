---
- debug:
    msg: Install ElasticSearch

- name: Update packages
  shell: zypper update -y
  become: true

- name: Get PGP Key
  shell: rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
  become: true

- name: Copy ElasticSearchRepo
  template: 
      src: elasticsearch.repo
      dest: /etc/zypp/repos.d/elasticsearch.repo
  become: true

- name: Install ElasticSearchRepo
  shell: zypper modifyrepo --enable elasticsearch && zypper -n install elasticsearch
  become: true

- name: Create folder
  shell: sudo mkdir /etc/systemd/system/elasticsearch.service.d
  become: true

- name: Change timeout
  shell: echo -e "[Service]\nTimeoutStartSec=180" | sudo tee /etc/systemd/system/elasticsearch.service.d/startup-timeout.conf
  become: true

- name: Daemon reload
  shell: systemctl daemon-reload
  become: true

- name: Start elasticsearch
  shell: systemctl start elasticsearch
  become: true

- name: Test elasticsearch
  shell: curl http://localhost:9200/
  become: true

- name: Create user
  shell: "/usr/share/elasticsearch/bin/elasticsearch-users useradd newrelic -p testpassword -r superuser"
  become: true

- name: Restart ElasticSearch
  shell: systemctl restart elasticsearch
  become: true 
