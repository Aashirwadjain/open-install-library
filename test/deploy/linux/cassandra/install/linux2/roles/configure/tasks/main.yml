---
- debug:
    msg: Install Cassandra

- name: Get latest packages info
  shell: "yum update -y"
  become: true

- name: Install epel
  shell: "amazon-linux-extras install epel -y"
  become: yes

- name: Install Java
  shell: "yum install java-1.8.0-openjdk -y"
  become: true

- name: Copy cassandra repo file
  template:
    src: cassandra311x.repo
    dest: /etc/yum.repos.d/cassandra311x.repo
  become: true

- name: install the Cassandra engine
  shell: "yum install cassandra -y"
  become: true

- name: "Allow to create user"
  shell: "cd /etc/cassandra/conf; sudo sed -i 's/authenticator: AllowAllAuthenticator/authenticator: PasswordAuthenticator/g' cassandra.yaml"
  become: true

- name: Restart cassandra
  shell: "service cassandra restart; systemctl restart cassandra"
  become: true

- name: Wait
  pause:
    seconds: 15
  become: true

- name: "Login to cassandra with default username and password"
  shell: "cqlsh -u cassandra -p cassandra"
  become: true

- name: "Create user"
  shell: "CREATE USER test WITH PASSWORD test"
  become: true
# - name: Reload daemon
#   shell: "systemctl daemon-reload"
#   become: true

# - name: Restart cassandra
#   shell: "service cassandra restart"
#   become: yes
