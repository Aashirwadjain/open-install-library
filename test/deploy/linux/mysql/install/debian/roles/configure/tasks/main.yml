---
- debug:
    msg: Install MySQL

- name: Install MySQL extras
  apt:
    name: ['default-mysql-server']
    update_cache: yes
    state: latest
  become: yes

- name: Create Database
  command: |
    mysql -e "CREATE DATABASE IF NOT EXISTS MysqlSample;"
  become: yes

- name: Create User
  command: |
    mysql -e "CREATE USER 'newrelic'@'localhost' IDENTIFIED BY 'testpwd';"
  become: yes

- name: Modify User
  command: |
    mysql -e "GRANT REPLICATION CLIENT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Create env file
  shell: "touch /etc/profile.d/mysql_vars.sh"
  become: yes

- name: Export USERNAME
  shell: "echo export USERNAME=newrelic >> /etc/profile.d/mysql_vars.sh"
  become: yes

- name: Export PASSWORD
  shell: "echo export PASSWORD=testpwd >> /etc/profile.d/mysql_vars.sh"
  become: yes

- name: Export HOSTNAME
  shell: "echo export HOSTNAME=localhost >> /etc/profile.d/mysql_vars.sh"
  become: yes

- name: Export DB_PORT
  shell: "echo export DB_PORT=3306 >> /etc/profile.d/mysql_vars.sh"
  become: yes

- name: Export DATABASE
  shell: "echo export DATABASE=MysqlSample >> /etc/profile.d/mysql_vars.sh"
  become: yes

- name: Check MySQL status
  shell: "service mysql start"
  become: yes

- name: Initialize profile.d
  shell: ". /etc/profile.d/mysql_vars.sh"

- name: Reset ssh connection
  meta: reset_connection
