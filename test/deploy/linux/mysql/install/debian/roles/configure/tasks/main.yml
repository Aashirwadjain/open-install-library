---
- debug:
    msg: Install MySQL

- name: Install MySQL extras
  apt:
    name: ['default-mysql-server']
    update_cache: yes
    state: latest
  become: yes

- name: Generate password for newrelic user
  shell: openssl rand -base64 14
  register: generatedPassword

- name: Set password as variable
  set_fact:
    generatedPassword={{ generatedPassword.stdout }}

- name: Create Database
  command: |
    mysql -e "CREATE DATABASE IF NOT EXISTS MysqlSample;"
  become: yes

- name: Remove previous created user
  command: |
    sudo mysql -u root -ne "DROP USER 'newrelic'@'localhost';"
  become: yes
  ignore_errors: yes

- name: Create User
  command: |
    mysql -u root -ne "CREATE USER 'newrelic'@'localhost' IDENTIFIED BY '{{ generatedPassword }}';"
  become: yes

- name: Grant replication permission to user
  command: |
    mysql -u root -ne "GRANT REPLICATION CLIENT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Grant select permission to user
  command: |
    mysql -u root -ne "GRANT SELECT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Export USERNAME
  shell: "echo export NR_CLI_DB_USERNAME=newrelic >> ~/.bashrc"

- name: Export PASSWORD
  shell: "echo export NR_CLI_DB_PASSWORD={{ generatedPassword }} >> ~/.bashrc"

- name: Export HOSTNAME
  shell: "echo export NR_CLI_DB_HOSTNAME=localhost >> ~/.bashrc"

- name: Export DB_PORT
  shell: "echo export NR_CLI_DB_PORT=3306 >> ~/.bashrc"

- name: Export DATABASE
  shell: "echo export NR_CLI_DATABASE=MysqlSample >> ~/.bashrc"

- name: Check MySQL status
  shell: "service mysql start"
  become: yes
