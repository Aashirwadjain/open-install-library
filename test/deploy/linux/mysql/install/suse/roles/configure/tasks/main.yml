---
- debug:
    msg: Install MySQL

- name: Install wget
  shell: "zypper -n install wget"
  become: yes
   
- name: Download MySQL SUSE repository
  shell: "wget https://dev.mysql.com/get/mysql80-community-release-sles12-3.noarch.rpm"
  become: yes

- name: Install MySQL SUSE repository
  shell: "rpm -ivh mysql80-community-release-sles12-3.noarch.rpm"
  become: yes

- name: Import GPG key for MySQL SUSE repository
  shell: "rpm --import /etc/RPM-GPG-KEY-mysql"
  become: yes

- name: Refresh zypper repository information
  shell: "zypper refresh"
  become: yes

- name: Install MySQL
  shell: "zypper -n install mysql-community-server"
  become: yes

- name: Create Database
  command: |
    mysql -e "CREATE DATABASE IF NOT EXISTS MysqlSample;"
  become: yes

- name: Create User
  command: |
    mysql -e "CREATE USER 'newrelic'@'localhost' IDENTIFIED BY 'testpwd';"
  become: yes

- name: Modify User
  command: |
    mysql -e "GRANT REPLICATION CLIENT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Export Variables
  set_fact: 
     env_vars: "{{ env_vars }} USERNAME=newrelic PASSWORD=testpwd HOSTNAME=localhost DB_PORT=3306"

- name: Enable MySQL service
  shell: "/sbin/chkconfig --add mysql"

- name: Restart MySQL
  shell: "systemctl restart mysql"
  become: yes
