---
- debug:
    msg: Install MySQL

- name: Add MySQL Repository
  yum: 
    name: https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
    state: present
  become: yes

- name: Install epel
  shell: "amazon-linux-extras install epel -y"
  become: yes

- name: Install the MySQL
  shell: "yum install mysql-community-server -y"
  become: yes

- name: Install systemctl
  shell: "yum install -y /usr/bin/systemctl; systemctl --version"
  become: yes

- name: Disable mysqld
  shell: "systemctl stop mysqld"
  become: yes

- name: Remove /var/lib/mysql/*
  shell: "rm -rf /var/lib/mysql/*"
  become: yes

- name: Start mysqld service
  shell: "systemctl start mysqld"
  become: yes

- name: Get temporary pwd for mysql
  shell: "grep 'temporary password' /var/log/mysqld.log | awk '{print $13}'"
  register: PW
  become: yes

- name: Set password as variable
  set_fact:
    PW={{ PW.stdout }}

- name: Create directory for limit file
  shell: "mkdir /etc/systemd/system/mysqld.service.d"
  become: yes

- name: Create file for limit
  shell: "touch /etc/systemd/system/mysqld.service.d/limits.conf"
  become: yes

- name: Fill conf file
  command: |
    tee /etc/systemd/system/mysqld.service.d/limits.conf > /dev/null <<"EOT"
    [Service]
    LimitNOFILE = 65535
    EOT
  become: yes

- name: Restart daemon
  shell: systemctl daemon-reload
  become: yes

- name: Restart Mysql
  shell: systemctl restart mysqld
  become: yes

- name: Create Database
  command: |
    mysql -u root -p{{ PW }} -e "CREATE DATABASE IF NOT EXISTS MysqlSample;"
  become: yes

- name: Create User
  command: |
    mysql -u root -p{{ PW }} -e "CREATE USER 'newrelic'@'localhost' IDENTIFIED BY 'NewLongerBetterTestPwd#11';"
  become: yes

- name: Grant replication permission to user
  command: |
    mysql -u root -p{{ PW }} -e "GRANT REPLICATION CLIENT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Grant select permission to user
  command: |
    mysql -u root -p{{ PW }} -ne "GRANT SELECT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Export USERNAME
  shell: "echo export NR_CLI_DB_USERNAME=newrelic >> ~/.bashrc"

- name: Export PASSWORD
  shell: "echo export NR_CLI_DB_PASSWORD=NewLongerBetterTestPwd#11 >> ~/.bashrc"

- name: Export HOSTNAME
  shell: "echo export NR_CLI_DB_HOSTNAME=localhost >> ~/.bashrc"

- name: Export DB_PORT
  shell: "echo export NR_CLI_DB_PORT=3306 >> ~/.bashrc"

- name: Export DATABASE
  shell: "echo export NR_CLI_DATABASE=MysqlSample >> ~/.bashrc"

- name: Start mysql service
  shell: "systemctl enable --now mysqld"
  become: yes
