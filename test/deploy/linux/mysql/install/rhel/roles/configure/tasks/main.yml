---
- debug:
    msg: Install MySQL

- name: Add MySQL Repository
  yum: 
    name: https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
    state: present
  become: yes

- name: Install epel
  shell: "amazon-linux-extras install epel -y"
  become: yes

- name: Install the MySQL
  shell: "yum install mysql-community-server -y"
  become: yes

- name: Install systemctl
  shell: "yum install -y /usr/bin/systemctl; systemctl --version"
  become: yes

- name: Create Database
  command: |
    mysql -e "CREATE DATABASE IF NOT EXISTS MysqlSample;"
  become: yes

- name: Create User
  command: |
    mysql -e "CREATE USER 'newrelic'@'localhost' IDENTIFIED BY 'testpwd';"
  become: yes

- name: Modify User
  command: |
    mysql -e "GRANT REPLICATION CLIENT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
  become: yes

- name: Export Variables
  set_fact: 
     env_vars: "{{ env_vars }} USERNAME=newrelic PASSWORD=testpwd HOSTNAME=localhost DB_PORT=3306"
     
- name: Start mysql service
  shell: "systemctl enable --now mysqld"
  become: yes
