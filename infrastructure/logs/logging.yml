install:
  version: "3"

  tasks:
    default:
      cmds:
        - task: setup

    setup:
      cmds:
        - |
          sudo mkdir -p "/etc/newrelic-infra/logging.d"
        - |
          if [ -f /etc/newrelic-infra/logging.d/logging.yml ]; then
            sudo rm /etc/newrelic-infra/logging.d/logging.yml;
          fi

          sudo touch /etc/newrelic-infra/logging.d/logging.yml;
        - |
          # Enable infra-agent logs to New Relic
          echo -e "verbose: 3\nlog_format: json" >> /etc/newrelic-infra/newrelic-infra.yml
        - |
          sudo tee -a /etc/newrelic-infra/logging.d/logging.yml > /dev/null <<"EOT"
          logs:
            - name: syslog
              file: /var/log/syslog
            - name: messages
              file: /var/log/messages
          EOT
        - sudo systemctl restart newrelic-infra.service
