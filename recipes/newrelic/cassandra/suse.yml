name: Cassandra Open Source Integration
description: New Relic install recipe for default Cassandra Open Source on-host integration (via Infra-Agent)
repository: https://github.com/newrelic/nri-cassandra

installTargets:
  - type: host
    os: linux
    platformFamily: "suse"

# keyword convention for dealing with search terms that could land someone on this instrumentation project
keywords:
  - Infrastructure
  - Integration
  - Cassandra

# Examine Infrastructure events for correlated data
processMatch:
  - /CassandraSample/
  - /CassandraColumnFamilySample/

# Matches partial list of the Log forwarding parameters
logMatch: 
  - name: cassandra
    file: /var/log/cassandra/access.log*
    attributes:
      logtype: cassandra
  - name: cassandra
    file: /var/log/cassandra/error.log*
    attributes:
      logtype: cassandra-error

validationNrql: "SELECT count(*) from CassandraSample where hostname like 'HOSTNAME' SINCE 10 minutes ago"

inputVars: 
  - name: "CASSANDRA_DB_USERNAME"
    prompt: "Enter username"
  - name: "CASSANDRA_DB_PASSWORD"
    prompt: "Enter password"
    secret: true
  - name: "CASSANDRA_DB_HOSTNAME" 
    prompt: "Confirm default or enter new value"
    default: "User hostname"
  - name: "CASSANDRA_DB_PORT"
    prompt: "Confirm default port or enter new value"
    default: 9042

install:
  version: "3"
  silent: true

  variables:
    - KEY_STORE: false
    - KEY_STORE_PASSWORD: false
    - TRUST_STORE: false
    - TRUST_STORE_PASSWORD: false
    - TIMEOUT: 5000
    - CONFIG_PATH: /etc/cassandra/cassandra.yaml

  tasks:
    default:
      cmds:
        - task: setup
        - task: restart

    setup:
      label: "Installing cassandra integration..."
      cmds:
       - |
         sudo mkdir -p "/etc/newrelic-infra/integrations.d"
       - |
         sudo zypper -n ref -r newrelic-infra
       - |
         sudo zypper -n install nri-cassandra
       - |
          if [ -f /etc/newrelic-infra/integrations.d/cassandra-config.yml ]; then
            sudo rm /etc/newrelic-infra/integrations.d/cassandra-config.yml;
          fi

          sudo touch /etc/newrelic-infra/integrations.d/cassandra-config.yml;
        - |
          sudo tee -a /etc/newrelic-infra/integrations.d/cassandra-config.yml > /dev/null <<"EOT"
          integration_name: com.newrelic.cassandra

          instances: 
            - name: cassandra-db-metrics
              command: metrics
              arguments:
                hostname: {{.CASSANDRA_DB_HOSTNAME}}
                port: {{.CASSANDRA_DB_PORT}}
                username: {{.CASSANDRA_DB_USERNAME}}
                password: {{.CASSANDRA_DB_PASSWORD}}
                timeout: {{.TIMEOUT}}
                key_store: {{.KEY_STORE}}
                key_store_password: {{.KEY_STORE_PASSWORD}}
                trust_store: {{.TRUST_STORE}}
                trust_store_password: {{.TRUST_STORE_PASSWORD}}
              labels:
                env: production
                role: cassandra-status
            - name: cassandra-db-inventory
              command: inventory
              arguments:
                hostname: {{.CASSANDRA_DB_HOSTNAME}}
                config_path: {{.CONFIG_PATH}}
              labels: 
                env: production
                role: cassandra-status

    restart: 
      cmds: 
        - sudo systemctl restart newrelic-infra.service
        