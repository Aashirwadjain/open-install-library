name: MySQL Open Source Integration
description: New Relic install recipe for default MySQL Open Source on-host integration (via Infra-Agent)
repository: https://github.com/newrelic/nri-mysql

installTargets:
  - type: host
    os: linux
    platform: amazonLinux
    platformVersion: "2"
  - type: host
    os: linux
    platform: "redhat"
  - type: host
    os: linux
    platform: "centos"

# keyword convention for dealing with search terms that could land someone on this instrumentation project
keywords:
  - Infrastructure
  - Integration
  - mysql

# Examine Infrastructure events for correlated data
processMatch:
  - /MysqlSample/

# Examine Metrics, Events, and Logging for correlated data
# Used by the UI to determine if you've successfully configured and are ingesting data
meltMatch:
  metrics:
    pattern:
    #Default metrics:
      - /cluster.slaveRunning/
      - /db.handlerRollbackPerSecond/
      - /db.innodb.bufferPoolPagesData/
      - /db.innodb.bufferPoolPagesFree/
      - /db.innodb.bufferPoolPagesTotal/
      - /db.innodb.dataReadByBytesPerSecond/
      - /db.innodb.logWaitsPerSecond/
      - /db.innodb.rowLockCurrentWaits/
      - /db.innodb.rowLockTimeAvg/
      - /db.innodb.rowLockWaitsPerSecond/
      - /db.openedTablesPerSecond/
      - /db.openFiles/
      - /db.openTables/
      - /db.qCacheFreeMemory/
      - /db.qCacheHitRatio/
      - /db.qCacheNotCachedPerSecond/
      - /db.qCacheUtilization/
      - /db.tablesLocksWaitedPerSecond/
      - /net.abortedClientsPerSecond/
      - /net.abortedConnectsPerSecond/
      - /net.bytesReceivedPerSecond/
      - /net.bytesSentPerSecond/
      - /net.connectionErrorMaxConnectionsPerSecond/
      - /net.connectionsPerSecond/
      - /net.maxUsedConnections/
      - /net.threadsConnected/
      - /net.threadsRunning/
      - /query.comDeletePerSecond/
      - /query.comDeleteMultiPerSecond/
      - /query.comInsertPerSecond/
      - /query.comInsertSelectPerSecond/
      - /query.comReplaceSelectPerSecond/
      - /query.comSelectPerSecond/
      - /query.comUpdateMultiPerSecond/
      - /query.comUpdatePerSecond/
      - /query.preparedStmtCountPerSecond/
      - /query.queriesPerSecond/
      - /query.questionsPerSecond/
      - /query.slowQueriesPerSecond/
    #ExtendedMetrics:
      - /db.createdTmpDiskTablesPerSecond/
      - /db.createdTmpFilesPerSecond/
      - /db.createdTmpTablesPerSecond/
      - /db.handlerDeletePerSecond/
      - /db.handlerReadFirstPerSecond/
      - /db.handlerReadKeyPerSecond/
      - /db.handlerReadRndNextPerSecond/
      - /db.handlerReadRndPerSecond/
      - /db.handlerUpdatePerSecond/
      - /db.handlerWritePerSecond/
      - /db.maxExecutionTimeExceededPerSecond/
      - /db.qCacheFreeBlocks/
      - /db.qCacheHitsPerSecond/
      - /db.qCacheInserts/
      - /db.qCacheLowmemPrunesPerSecond/
      - /db.qCacheQueriesInCachePerSecond/
      - /db.qCacheTotalBlocks/
      - /db.selectFullJoinPerSecond/
      - /db.selectFullJoinRangePerSecond/
      - /db.selectRangeCheckPerSecond/
      - /db.selectRangePerSecond/
      - /db.sortMergePassesPerSecond/
      - /db.sortRangePerSecond/
      - /db.sortRowsPerSecond/
      - /db.sortScanPerSecond/
      - /db.tableOpenCacheHitsPerSecond/
      - /db.tableOpenCahceMissesPerSecond/
      - /db.tableOpenCacheOverflowsPerSecond/
      - /db.threadCacheMissRate/
      - /db.threadsCached/
      - /db.threadsCreatedPerSecond/
    #Extended innodb metrics:
      - /db.innodb.bufferPoolPagesDirty/
      - /db.innodb.bufferPoolPagesFlushedPerSecond/
      - /db.innodb.bufferPoolReadAheadEvictedPerSecond/
      - /db.innodb.bufferPoolReadAheadPerSecond/
      - /db.innodb.bufferPoolReadAheadRndPerSecond/
      - /db.innodb.bufferPoolReadRequestsPerSecond/
      - /db.innodb.bufferPoolReadsPerSecond/
      - /db.innodb.bufferPoolWaitFreePerSecond/
      - /db.innodb.bufferPoolWriteRequestsPerSecond/
      - /db.innodb.dataFsyncsPerSecond
      - /db.innodb.dataPendingFsynsc/
      - /db.innodb.dataPendingReads/
      - /db.innodb.dataPendingWrites/
      - /db.innodb.dataReadsPerSecond/
      - /db.innodb.dataWritesPerSecond/
      - /db.innodb.logWriteRequestsPerSecond/
      - /db.innodb.logWritesPerSecond/
      - /db.innodb.numOpenFiles/
      - /db.innodb.osLogFsyncsPerSecond/
      - /db.innodb.osLogPendingFsyncs/
      - /db.innodb.osLogPendingWrites/
      - /db.innodb.osLogWrittenBytesPerSecond/ #rate word in documentation, part of pattern?
      - /db.innodb.pagesCreatedPerSecond/
      - /db.innodb.pagesReadPerSecond/
      - /db.innodb.pagesWrittenPerSecond/
      - /db.innodb.rowsDeletedPerSecond/
      - /db.innodb.rowsInsertedPerSecond/
      - /db.innodb.rowsReadPerSecond/
      - /db.innodb.rowsUpdatedPerSecond/
    #Extended myisam metrics:
      - /db.myisam.keyBlocksNotFlushed/
      - /db.myisam.keyCacheUtilization/
      - /db.myisam.keyReadRequestsPerSecond/
      - /db.myisam.keyReadsPerSecond/
      - /db.myisam.keyWriteRequestsPerSecond/
      - /db.myisam.kerWritesPerSecond/
    #Extended slave cluster metrics:
      - /db.relayLogSpace/
      - /cluster.lastIOErrno/
      - /cluster.lastIOError/
      - /cluster.lastSQLErrno/
      - /cluster.lastSQLError/
      - /cluster.slaveIORunning/
      - /cluster.secondsBehindMaster/
      - /cluster.masterLogFile/
      - /cluster.readMasterLogPos/
      - /cluster.relayMasterLogFile/
      - /cluster.execMasterLogPos/
    #System metadata:
      - /software.edition/
      - /software.version/
      - /cluster.nodeType/
  logMatch:
    - name: "LogMySQL"
      pattern: /mysql/
      file: /var/log/mysql/

inputVars:
  - name: "CreatedUserPassword"
    prompt: "Please enter your desired password below."
    secret: true
  - name: "DB_USERNAME"
    prompt: "Please enter your MySQL username below."
  - name: "DB_PASSWORD"
    prompt: "Please enter your MySQL password below."
    secret: true
  - name: "DB_HOSTNAME"
    prompt: "Please enter your MySQL hostname below. If none is provided, the default value: localhost, will be used."
    default: "localhost"
  - name: "DB_PORT"
    prompt: "Please enter your MySQL port below. If none is provided, the default value: 3306, will be used."
    default: 3306

install:
  version: "3"

  silent: true

  variables:
    - EXTENDED_METRICS: false
    - EXTENDED_INNODB_METRICS: false
    - EXTENDED_MYISAM_METRICS: false

  tasks:
    default:
      cmds:
        - task: install_integration
        - task: create_user
        - task: setup
        - task: restart

    install_integration:
      label: "Installing MySQL integration..."
      cmds:
        - |
          sudo yum -q makecache -y --disablerepo='*' --enablerepo='newrelic-infra'
        - |
          sudo yum install nri-mysql -y
    create_user:
      cmds:
        - |
          sudo mysql -e "CREATE USER 'newrelic'@'localhost' IDENTIFIED BY '{{.CreatedUserPassword}}';"
        - |
          sudo mysql -e "GRANT REPLICATION CLIENT ON *.* TO 'newrelic'@'localhost' WITH MAX_USER_CONNECTIONS 5;"
    setup:
      cmds:
        - |
          sudo mkdir -p "/etc/newrelic-infra/integrations.d"
        - |
          if [ -f /etc/newrelic-infra/integrations.d/mysql-config.yml ]; then
            sudo rm /etc/newrelic-infra/integrations.d/mysql-config.yml;
          fi

          sudo touch /etc/newrelic-infra/integrations.d/mysql-config.yml;
        - |
          sudo tee -a /etc/newrelic-infra/integrations.d/mysql-config.yml > /dev/null <<"EOT"
          integration_name: com.newrelic.mysql

          instances: 
            - name: mysql-status
              command: status
              arguments:
                hostname: {{.DB_HOSTNAME}}
                port: {{.DB_PORT}}
                username: {{.DB_USERNAME}}
                password: {{.DB_PASSWORD}}
                extended_metrics: {{.EXTENDED_METRICS}}
                extended_innodb_metrics: {{.EXTENDED_INNODB_METRICS}}
                extended_myisam_metrics: {{.EXTENDED_MYISAM_METRICS}}
              labels:
                env: production
                role: load_balancer
    restart:
      cmds:
        - sudo systemctl restart newrelic-infra.service
